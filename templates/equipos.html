<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Equipos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body class="bg-light">
<div class="container py-4">
    <a href="/admin" class="btn btn-secondary mb-4">← Regresar al panel</a>

    {% if mensaje_alert %}
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050">
        <div id="liveToast" class="toast align-items-center text-bg-{{ mensaje_alert.tipo }} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    {{ mensaje_alert.texto }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const toastEl = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();
    </script>
    {% endif %}

    <h3>Listado de equipos</h3>
    {% if request.query_params.get("eliminado") %}
    <div class="alert alert-success">✅ Equipo eliminado correctamente.</div>
    {% elif request.query_params.get("error") == "notfound" %}
    <div class="alert alert-danger">❌ El equipo no fue encontrado.</div>
    {% endif %}
    <p>Total equipos: {{ equipos|length }}</p>

    <table class="table table-bordered table-striped mt-3">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Código</th>
                <th>Edificio</th>
                <th>Tipo</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Serie</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for e in equipos %}
            <tr>
                <td>{{ e.id_equipo }}</td>
                <td>{{ e.codigo }}</td>
                <td>{{ e.edificio_nombre }}</td>
                <td>{{ e.tipo_nombre }}</td>
                <td>{{ e.marca }}</td>
                <td>{{ e.modelo }}</td>
                <td>{{ e.serie }}</td>
                <td>{{ e.estado }}</td>
                <td>{{ e.fecha_registro.strftime('%Y-%m-%d') if e.fecha_registro else '' }}</td>
                <td class="d-flex gap-2">
                    {% if e.tipo_nombre.lower() == "cpu" %}
                    <button class="btn btn-info btn-sm" onclick="toggleDetalles({{ e.id_equipo }})">Ver detalles</button>
                    {% endif %}
                    <form method="post" action="/equipos/{{ e.id_equipo }}/eliminar" onsubmit="return confirm('¿Estás seguro de que deseas eliminar este equipo?')">
                        <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                    </form>
                </td>
            </tr>

            {% if e.tipo_nombre.lower() == "cpu" %}
            <tr id="detalles-{{ e.id_equipo }}" style="display: none;">
                <td colspan="10">
                    <form method="post" action="/equipos/{{ e.id_equipo }}/detalles/actualizar" class="row g-3">
                        <h6 class="mt-2">Detalles técnicos</h6>
                        <div class="col-md-2">
                            <input type="number" name="ram_gb" class="form-control" placeholder="RAM (GB)" 
                                   value="{{ e.ram_gb if e.ram_gb is not none else '' }}"
                                   onchange="handleNumberInput(this)">
                        </div>
                        <div class="col-md-2"><input type="text" name="tipo_ram" class="form-control" placeholder="Tipo RAM" value="{{ e.tipo_ram or '' }}"></div>
                        <div class="col-md-2">
                            <input type="number" name="almacenamiento_gb" class="form-control" placeholder="Almacenamiento (GB)" 
                                   value="{{ e.almacenamiento_gb if e.almacenamiento_gb is not none else '' }}"
                                   onchange="handleNumberInput(this)">
                        </div>
                        <div class="col-md-2"><input type="text" name="tipo_almacenamiento" class="form-control" placeholder="Tipo almacenamiento" value="{{ e.tipo_almacenamiento or '' }}"></div>
                        <div class="col-md-4"><input type="text" name="procesador" class="form-control" placeholder="Procesador" value="{{ e.procesador or '' }}"></div>
                        <div class="col-md-12"><textarea name="otros_detalles" class="form-control" placeholder="Otros detalles">{{ e.otros_detalles or '' }}</textarea></div>

                        <hr class="mt-4 mb-2">
                        <h6>Gráfica dedicada</h6>
                        <div class="col-md-3"><input type="text" name="grafica_marca" class="form-control" placeholder="Marca de gráfica" value="{{ e.grafica_marca or '' }}"></div>
                        <div class="col-md-5"><input type="text" name="grafica_modelo" class="form-control" placeholder="Modelo de gráfica" value="{{ e.grafica_modelo or '' }}"></div>
                        <div class="col-md-2">
                            <input type="number" name="vram_gb" class="form-control" placeholder="VRAM (GB)" 
                                   value="{{ e.vram_gb if e.vram_gb is not none else '' }}"
                                   onchange="handleNumberInput(this)">
                        </div>

                        <hr class="mt-4 mb-2">
                        <h6>Periféricos asociados</h6>
                        <div id="perifericosContainer-{{ e.id_equipo }}" class="row g-3">
                            {% for p in e.perifericos %}
                            <div class="row g-3 mt-2">
                                <div class="col-md-3">
                                    <select name="perifericos[{{ loop.index0 }}][tipo]" class="form-select" required>
                                        <option value="Monitor" {% if p.tipo=="Monitor" %}selected{% endif %}>Monitor</option>
                                        <option value="Teclado" {% if p.tipo=="Teclado" %}selected{% endif %}>Teclado</option>
                                        <option value="Mouse" {% if p.tipo=="Mouse" %}selected{% endif %}>Mouse</option>
                                        <option value="Bocina" {% if p.tipo=="Bocina" %}selected{% endif %}>Bocina</option>
                                    </select>
                                </div>
                                <div class="col-md-3"><input type="text" name="perifericos[{{ loop.index0 }}][marca]" class="form-control" value="{{ p.marca }}"></div>
                                <div class="col-md-3"><input type="text" name="perifericos[{{ loop.index0 }}][modelo]" class="form-control" value="{{ p.modelo }}"></div>
                                <div class="col-md-3"><input type="text" name="perifericos[{{ loop.index0 }}][serie]" class="form-control" value="{{ p.serie }}"></div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="col-12 text-end mt-3">
                            <button type="submit" class="btn btn-primary btn-sm">Guardar cambios</button>
                        </div>
                    </form>
                </td>
            </tr>
            <script>
                contadorPerifericos[{{ e.id_equipo }}] = {{ e.perifericos|length }};
            </script>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <h4 class="mt-5">Registrar nuevo equipo</h4>
    <form method="post" action="/equipos/nuevo" class="row g-3 mb-4" id="nuevoEquipoForm">
        <div class="col-md-3"><input type="text" name="codigo" class="form-control" placeholder="Código del equipo" required></div>
        <div class="col-md-3">
            <select name="id_edificio" class="form-select" required>
                <option value="">Seleccione edificio</option>
                {% for ed in edificios %}
                <option value="{{ ed.id_edificio }}">{{ ed.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <select name="id_tipo" class="form-select" id="tipoEquipo" required onchange="mostrarDetallesCPU()">
                <option value="">Seleccione tipo</option>
                {% for tipo in tipos %}
                <option value="{{ tipo.id_tipo }}">{{ tipo.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3"><input type="text" name="marca" class="form-control" placeholder="Marca"></div>
        <div class="col-md-3"><input type="text" name="modelo" class="form-control" placeholder="Modelo"></div>
        <div class="col-md-3"><input type="text" name="serie" class="form-control" placeholder="Serie"></div>
        <div class="col-md-3">
            <select name="estado" class="form-select" required>
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
                <option value="Eliminado">Eliminado</option>
            </select>
        </div>

        <!-- Campos técnicos CPU -->
        <div id="camposCPU" class="row g-3 mt-2" style="display: none; flex-wrap: wrap;">
            <h6>Detalles técnicos</h6>
            <div class="col-md-2">
                <input type="number" name="ram_gb" class="form-control" placeholder="RAM (GB)" 
                       onchange="handleNumberInput(this)">
            </div>
            <div class="col-md-2"><input type="text" name="tipo_ram" class="form-control" placeholder="Tipo RAM"></div>
            <div class="col-md-2">
                <input type="number" name="almacenamiento_gb" class="form-control" placeholder="Almacenamiento (GB)" 
                       onchange="handleNumberInput(this)">
            </div>
            <div class="col-md-2"><input type="text" name="tipo_almacenamiento" class="form-control" placeholder="Tipo almacenamiento"></div>
            <div class="col-md-4"><input type="text" name="procesador" class="form-control" placeholder="Procesador"></div>
            <div class="col-md-12"><textarea name="otros_detalles" class="form-control" placeholder="Otros detalles técnicos"></textarea></div>

            <hr class="mt-4 mb-2">
            <h6>Gráfica dedicada</h6>
            <div class="col-md-3"><input type="text" name="grafica_marca" class="form-control" placeholder="Marca de gráfica"></div>
            <div class="col-md-5"><input type="text" name="grafica_modelo" class="form-control" placeholder="Modelo de gráfica"></div>
            <div class="col-md-2">
                <input type="number" name="vram_gb" class="form-control" placeholder="VRAM (GB)" 
                       onchange="handleNumberInput(this)">
            </div>

            <hr>
            <h6>Periféricos asociados</h6>
            <div id="perifericosContainer" class="row g-3"></div>
            <div class="col-12 text-end mt-2">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarPeriferico('nuevo')">
                    <i class="fas fa-plus me-1"></i>Agregar periférico
                </button>
            </div>
        </div>

        <div class="col-12 text-end mt-3">
            <button type="submit" class="btn btn-success">Registrar equipo</button>
        </div>
    </form>
</div>

<script>
function mostrarDetallesCPU() {
    const selectTipo = document.getElementById("tipoEquipo");
    const camposCPU = document.getElementById("camposCPU");
    const tipoSeleccionado = selectTipo.options[selectTipo.selectedIndex].text.toLowerCase();
    camposCPU.style.display = tipoSeleccionado === "cpu" ? "flex" : "none";
}

function toggleDetalles(id) {
    const fila = document.getElementById("detalles-" + id);
    fila.style.display = fila.style.display === "none" ? "table-row" : "none";
}

const contadorPerifericos = {};

function agregarPeriferico(id_equipo) {
    if (!(id_equipo in contadorPerifericos)) {
        contadorPerifericos[id_equipo] = 0;
    }
    const containerId = id_equipo === 'nuevo' ? 'perifericosContainer' : `perifericosContainer-${id_equipo}`;
    const container = document.getElementById(containerId);
    const index = contadorPerifericos[id_equipo];

    const div = document.createElement("div");
    div.classList.add("row", "g-3", "mt-2");
    div.innerHTML = `
        <div class="col-md-3">
            <select name="perifericos[${index}][tipo]" class="form-select" required>
                <option value="">Seleccione tipo</option>
                <option value="Monitor">Monitor</option>
                <option value="Teclado">Teclado</option>
                <option value="Mouse">Mouse</option>
                <option value="Bocina">Bocina</option>
            </select>
        </div>
        <div class="col-md-3"><input type="text" name="perifericos[${index}][marca]" class="form-control" placeholder="Marca"></div>
        <div class="col-md-3"><input type="text" name="perifericos[${index}][modelo]" class="form-control" placeholder="Modelo"></div>
        <div class="col-md-3"><input type="text" name="perifericos[${index}][serie]" class="form-control" placeholder="Serie"></div>
    `;
    container.appendChild(div);
    contadorPerifericos[id_equipo]++;
}

// Función para manejar campos numéricos vacíos
function handleNumberInput(input) {
    if (input.value === '') {
        // Si el campo está vacío, lo limpiamos completamente
        input.value = '';
    }
}

// Limpiar campos numéricos antes del envío del formulario
document.getElementById('nuevoEquipoForm')?.addEventListener('submit', function(e) {
    const numberInputs = this.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        if (input.value === '') {
            // Remover el atributo name temporalmente para que no se envíe
            input.setAttribute('data-original-name', input.name);
            input.removeAttribute('name');
        }
    });
});

// Para formularios de actualización
document.querySelectorAll('form[action*="/detalles/actualizar"]').forEach(form => {
    form.addEventListener('submit', function(e) {
        const numberInputs = this.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            if (input.value === '') {
                input.setAttribute('data-original-name', input.name);
                input.removeAttribute('name');
            }
        });
    });
});
</script>
</body>
</html>
